# =====================================================
# RabbitMQ Configuration for PDF Converter
# =====================================================
# Optimized for reliable job queuing and message processing

# =====================================================
# NETWORK SETTINGS
# =====================================================
listeners.tcp.default = 5672
listeners.ssl.default = 5671

# Management plugin HTTP listener
management.tcp.port = 15672

# Clustering
cluster_formation.peer_discovery_backend = classic_config

# =====================================================
# MEMORY AND DISK SETTINGS
# =====================================================
# Memory high watermark - stop accepting messages when memory usage exceeds this
vm_memory_high_watermark.relative = 0.6

# Paging threshold - start paging messages to disk when memory usage exceeds this  
vm_memory_high_watermark_paging_ratio = 0.5

# Disk free space limit - stop accepting messages when disk free space falls below this
disk_free_limit.absolute = 2GB

# =====================================================
# MESSAGE STORE SETTINGS
# =====================================================
# Message store index sync interval
msg_store_index_sync_interval = 2000

# Message store cache size
msg_store_cache_size = 2048

# =====================================================
# QUEUE SETTINGS
# =====================================================
# Default queue type (classic or quorum)
default_queue_type = classic

# Maximum queue length (messages)
default_max_length = 100000

# Maximum queue size (bytes)  
default_max_length_bytes = 1GB

# Message TTL for queues without explicit TTL (24 hours)
default_message_ttl = 86400000

# Queue master failover strategy
queue_master_locator = min-masters

# =====================================================
# CONNECTION SETTINGS
# =====================================================
# Heartbeat interval (seconds)
heartbeat = 60

# Connection timeout  
handshake_timeout = 10000

# Frame maximum size
frame_max = 131072

# Channel maximum number per connection
channel_max = 2047

# =====================================================
# AUTHENTICATION AND SECURITY
# =====================================================
# Default user (will be created if not exists)
default_user = rabbit_admin
default_pass = RabbitSecure2024!

# User permissions
default_permissions.configure = .*
default_permissions.read = .*
default_permissions.write = .*

# Guest user access (disable for security)
loopback_users.guest = false

# SSL settings (commented out for development)
# ssl_options.cacertfile = /etc/rabbitmq/ca_certificate.pem
# ssl_options.certfile   = /etc/rabbitmq/server_certificate.pem
# ssl_options.keyfile    = /etc/rabbitmq/server_key.pem
# ssl_options.verify     = verify_peer
# ssl_options.fail_if_no_peer_cert = true

# =====================================================
# LOGGING
# =====================================================
# Log level: debug, info, warning, error, critical, none
log.console = true
log.console.level = error

# Log to file
log.file.level = error
log.file.rotation.date = $D0
log.file.rotation.size = 10485760

# Connection logging
log.connection.level = error

# Channel logging  
log.channel.level = error

# Queue logging
log.queue.level = error

# Mirroring logging
log.mirroring.level = error

# Federation logging
log.federation.level = error

# Upgrade logging
log.upgrade.level = error

# =====================================================
# PERFORMANCE TUNING
# =====================================================
# Collect statistics
collect_statistics = coarse
collect_statistics_interval = 5000

# Background garbage collection interval
background_gc_enabled = true
background_gc_target_interval = 60000

# TCP buffer sizes
tcp_listen_options.backlog = 128
tcp_listen_options.nodelay = true
tcp_listen_options.linger.on = true  
tcp_listen_options.linger.timeout = 0
tcp_listen_options.exit_on_close = false

# =====================================================
# CLUSTERING SETTINGS (for future scaling)
# =====================================================
# Cluster partition handling
cluster_partition_handling = ignore

# Cluster keepalive interval
cluster_keepalive_interval = 10000

# Net ticktime for clustering
net_ticktime = 60

# =====================================================
# MANAGEMENT PLUGIN SETTINGS
# =====================================================
# Enable management plugin
management.load_definitions = /etc/rabbitmq/definitions.json

# Sample retention policies for management stats
management.sample_retention_policies.global.minute = 5
management.sample_retention_policies.global.hour = 60  
management.sample_retention_policies.global.day = 1200

management.sample_retention_policies.basic.minute = 5
management.sample_retention_policies.basic.hour = 60

management.sample_retention_policies.detailed.minute = 10

# Management HTTP request timeout
management.http_log_dir = /var/log/rabbitmq

# =====================================================
# PLUGIN CONFIGURATION
# =====================================================
# Enabled plugins (will be loaded at startup)
# Management plugin provides web UI
# Shovel plugin for message forwarding (if needed)
# Federation plugin for message distribution (if needed)

# =====================================================
# RESOURCE LIMITS
# =====================================================
# Max number of file handles
max_open_files = 65536

# Process limits
process_limit = 1048576

# =====================================================
# PDF CONVERTER SPECIFIC SETTINGS
# =====================================================

# =====================================================
# QUEUE STRATEGY FOR PDF CONVERTER:
# =====================================================
# 1. pdf-conversion-queue: Main queue for conversion jobs
#    - Durable: Yes (survive broker restart)
#    - Priority: Yes (1-10, higher = more priority)
#    - TTL: 30 minutes (job expires if not processed)
#    - DLX: pdf-conversion-failed (dead letter exchange)
#    - Max Length: 10,000 jobs
#    - Max Retries: 3 attempts

# 2. pdf-conversion-priority-queue: High priority jobs
#    - For premium users and urgent conversions
#    - Higher consumer prefetch
#    - Shorter TTL (15 minutes)

# 3. notification-queue: User notifications
#    - Fast processing queue
#    - TTL: 24 hours  
#    - Max Length: 50,000 notifications

# 4. webhook-queue: Webhook deliveries
#    - Retry with exponential backoff
#    - TTL: 7 days
#    - DLX for failed deliveries

# 5. cleanup-queue: File cleanup tasks
#    - Low priority background queue
#    - Long TTL (7 days)
#    - Single consumer

# =====================================================
# EXCHANGE STRATEGY:
# =====================================================
# pdf-converter-exchange: Main direct exchange
# pdf-converter-fanout: Broadcast notifications  
# pdf-converter-dlx: Dead letter exchange
# pdf-converter-delay: Delayed message exchange

# =====================================================
# ROUTING KEYS:
# =====================================================
# convert.pdf: PDF conversion jobs
# convert.priority: Priority conversion jobs
# notify.user: User notifications
# notify.admin: Admin notifications  
# webhook.delivery: Webhook deliveries
# cleanup.files: File cleanup tasks
# cleanup.temp: Temporary file cleanup

# =====================================================
# CONSUMER CONFIGURATION RECOMMENDATIONS:
# =====================================================
# Conversion workers: 
#   - prefetch_count = 1 (one job at a time per worker)
#   - ack_mode = manual (acknowledge after completion)
#   - timeout = 10 minutes per job

# Notification workers:
#   - prefetch_count = 10 (batch notifications)  
#   - ack_mode = manual
#   - timeout = 30 seconds per batch

# Webhook workers:
#   - prefetch_count = 5
#   - retry_policy = exponential_backoff
#   - max_retries = 5

# =====================================================
# MONITORING METRICS:
# =====================================================
# Key metrics to monitor:
# - Queue depth (messages waiting)
# - Consumer utilization 
# - Message publish/consume rates
# - Connection count
# - Memory usage
# - Disk usage
# - Failed message count (DLX)

# =====================================================
# SCALING CONSIDERATIONS:
# =====================================================
# Single node setup (current):
# - Handle ~1000 messages/second
# - Store ~1 million messages
# - Support ~100 concurrent connections

# Cluster setup (future):
# - Add nodes for higher throughput
# - Use quorum queues for better consistency
# - Implement proper monitoring and alerting